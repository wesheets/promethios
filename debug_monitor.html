<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promethios Tool Integration Debug Monitor</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            margin: 0;
            padding: 20px;
        }
        .header {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #00ff00;
        }
        .controls {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected { background: #004400; color: #00ff00; }
        .status.disconnected { background: #440000; color: #ff0000; }
        .status.connecting { background: #444400; color: #ffff00; }
        
        .logs-container {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            height: 70vh;
            overflow-y: auto;
            padding: 10px;
        }
        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid;
            font-size: 12px;
            line-height: 1.4;
        }
        .log-entry.info { border-color: #0099ff; background: rgba(0, 153, 255, 0.1); }
        .log-entry.debug { border-color: #666; background: rgba(102, 102, 102, 0.1); }
        .log-entry.warn { border-color: #ff9900; background: rgba(255, 153, 0, 0.1); }
        .log-entry.error { border-color: #ff0000; background: rgba(255, 0, 0, 0.1); }
        
        .log-timestamp {
            color: #888;
            font-size: 10px;
        }
        .log-category {
            color: #00ccff;
            font-weight: bold;
            text-transform: uppercase;
        }
        .log-message {
            color: #fff;
            margin: 5px 0;
        }
        .log-data {
            color: #ffcc00;
            font-size: 11px;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px;
            border-radius: 3px;
            margin-top: 5px;
            white-space: pre-wrap;
        }
        
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .filter-btn {
            padding: 5px 10px;
            border: 1px solid #555;
            background: #333;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        .filter-btn.active {
            background: #0066cc;
            border-color: #0099ff;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            font-size: 12px;
        }
        .stat {
            background: #2a2a2a;
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        button:hover {
            background: #0088ff;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç Promethios Tool Integration Debug Monitor</h1>
        <p>Real-time monitoring of tool calling process to identify silent failures</p>
    </div>
    
    <div class="controls">
        <span id="status" class="status disconnected">Disconnected</span>
        <button id="connectBtn" onclick="connect()">Connect</button>
        <button id="clearBtn" onclick="clearLogs()">Clear Logs</button>
        <button id="exportBtn" onclick="exportLogs()">Export Logs</button>
        <span>API URL: <input type="text" id="apiUrl" value="https://promethios-phase-7-1-api.onrender.com" style="background: #333; color: #fff; border: 1px solid #555; padding: 4px; border-radius: 3px;"></span>
    </div>
    
    <div class="stats">
        <div class="stat">Total Logs: <span id="totalLogs">0</span></div>
        <div class="stat">Tool Calls: <span id="toolCalls">0</span></div>
        <div class="stat">Errors: <span id="errors">0</span></div>
        <div class="stat">Last Update: <span id="lastUpdate">Never</span></div>
    </div>
    
    <div class="filter-controls">
        <button class="filter-btn active" data-category="all">All</button>
        <button class="filter-btn" data-category="tool_execution">Tool Execution</button>
        <button class="filter-btn" data-category="tool_schema">Tool Schema</button>
        <button class="filter-btn" data-category="provider">Provider</button>
        <button class="filter-btn" data-category="chat">Chat</button>
        <button class="filter-btn" data-category="openai_provider">OpenAI</button>
        <button class="filter-btn" data-category="anthropic_provider">Anthropic</button>
    </div>
    
    <div class="logs-container" id="logsContainer">
        <div style="text-align: center; color: #666; margin-top: 50px;">
            Click "Connect" to start monitoring tool integration logs...
        </div>
    </div>

    <script>
        let eventSource = null;
        let logs = [];
        let currentFilter = 'all';
        
        // Initialize filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.category;
                renderLogs();
            });
        });
        
        function connect() {
            const apiUrl = document.getElementById('apiUrl').value;
            const statusEl = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            
            if (eventSource) {
                eventSource.close();
            }
            
            statusEl.textContent = 'Connecting...';
            statusEl.className = 'status connecting';
            connectBtn.disabled = true;
            
            try {
                eventSource = new EventSource(`${apiUrl}/api/debug/live`);
                
                eventSource.onopen = function() {
                    statusEl.textContent = 'Connected';
                    statusEl.className = 'status connected';
                    connectBtn.textContent = 'Disconnect';
                    connectBtn.disabled = false;
                    connectBtn.onclick = disconnect;
                };
                
                eventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleMessage(data);
                    } catch (error) {
                        console.error('Error parsing message:', error);
                    }
                };
                
                eventSource.onerror = function(error) {
                    console.error('EventSource error:', error);
                    statusEl.textContent = 'Connection Error';
                    statusEl.className = 'status disconnected';
                    connectBtn.textContent = 'Reconnect';
                    connectBtn.disabled = false;
                    connectBtn.onclick = connect;
                };
                
            } catch (error) {
                console.error('Failed to connect:', error);
                statusEl.textContent = 'Failed to Connect';
                statusEl.className = 'status disconnected';
                connectBtn.disabled = false;
            }
        }
        
        function disconnect() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            
            const statusEl = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            
            statusEl.textContent = 'Disconnected';
            statusEl.className = 'status disconnected';
            connectBtn.textContent = 'Connect';
            connectBtn.onclick = connect;
        }
        
        function handleMessage(data) {
            if (data.type === 'new_log') {
                logs.unshift(data.log);
                if (logs.length > 1000) {
                    logs = logs.slice(0, 1000); // Keep only last 1000 logs
                }
                renderLogs();
                updateStats();
            } else if (data.type === 'initial_logs') {
                logs = data.logs || [];
                renderLogs();
                updateStats();
            }
            
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }
        
        function renderLogs() {
            const container = document.getElementById('logsContainer');
            const filteredLogs = currentFilter === 'all' 
                ? logs 
                : logs.filter(log => log.category === currentFilter);
            
            if (filteredLogs.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; margin-top: 50px;">
                        ${currentFilter === 'all' ? 'No logs yet...' : `No logs for category: ${currentFilter}`}
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredLogs.map(log => `
                <div class="log-entry ${log.level}">
                    <div class="log-timestamp">${new Date(log.timestamp).toLocaleTimeString()}</div>
                    <div class="log-category">[${log.category}]</div>
                    <div class="log-message">${log.message}</div>
                    ${log.data && Object.keys(log.data).length > 0 ? 
                        `<div class="log-data">${JSON.stringify(log.data, null, 2)}</div>` : 
                        ''
                    }
                </div>
            `).join('');
            
            // Auto-scroll to top for new logs
            container.scrollTop = 0;
        }
        
        function updateStats() {
            document.getElementById('totalLogs').textContent = logs.length;
            document.getElementById('toolCalls').textContent = logs.filter(log => 
                log.category.includes('tool') || log.message.includes('tool')
            ).length;
            document.getElementById('errors').textContent = logs.filter(log => 
                log.level === 'error'
            ).length;
        }
        
        function clearLogs() {
            logs = [];
            renderLogs();
            updateStats();
            
            // Also clear server logs
            const apiUrl = document.getElementById('apiUrl').value;
            fetch(`${apiUrl}/api/debug/clear`, { method: 'POST' })
                .catch(error => console.error('Failed to clear server logs:', error));
        }
        
        function exportLogs() {
            const dataStr = JSON.stringify(logs, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `promethios-debug-logs-${new Date().toISOString().slice(0, 19)}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        // Auto-connect on page load
        window.addEventListener('load', () => {
            setTimeout(connect, 1000);
        });
    </script>
</body>
</html>

